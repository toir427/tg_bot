// telegram api
const TelegramApi = require('node-telegram-bot-api')

// mongoose
const mongoose = require('mongoose')

// mongoose user model
const User = require('./user.js')

// telegram button options
const {
    slotMachineOptions,
    basketOptions,
    bowlingOptions,
    footballOptions,
    dartsOptions,
    gamesOptions
} = require('./options')

// supporting functions
const {declOfNum, generateName, delay} = require('./utils')

// private variables
const {token, mongoURI} = require('./private')

// bot
const bot = new TelegramApi(token, {polling: true})

const getBonus = async (telegramId, chatId, options = {}) => {
    // finding user
    const user = await User.findOne({telegramId})

    if (Date.now() / 3600000 > user.lastBonusTime) {
        // updating user coins and last bonus time
        await User.updateOne({telegramId}, {
            $inc: {coins: options.coinsNumber},
            $set: {lastBonusTime: (Date.now() / 3600000) + options.bonusTime}
        })

        await bot.sendMessage(chatId, `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${options.coinsNumber} ${declOfNum(options.coinsNumber, ['–º–æ–Ω–µ—Ç–∞', '–º–æ–Ω–µ—Ç—ã', '–º–æ–Ω–µ—Ç'])} üéâ`)
    } else {
        const minutes = Math.floor((((user.lastBonusTime - (Date.now() / 3600000)) % 1).toFixed(2)) * 60)
        const hours = minutes === 60 ? Math.floor(user.lastBonusTime - (Date.now() / 3600000)) + 1 : Math.floor(user.lastBonusTime - (Date.now() / 3600000))

        await bot.sendMessage(chatId, `–ü–æ–ª—É—á–∏—Ç—å –º–æ–Ω–µ—Ç—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ —á–µ—Ä–µ–∑ ${hours > 0 ? hours + ' ' + declOfNum(hours, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤']) + ' ' : ''}${minutes !== 60 ? minutes + ' ' + declOfNum(minutes, ['–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç']) + ' ' : ''}üòâ`)
    }
}

const createUser = async (telegramId, name) => {
    try {
        const candidate = await User.findOne({telegramId})

        if (candidate) {
            return
        }

        // creating new user
        const createdUser = await new User({telegramId, name})

        // saving user to bd
        await createdUser.save()
    } catch (e) {
        console.log(e)
    }
}

const updateRanking = async () => {
    const operations = []
    const users = await User.find({victories: {$exists: true}}).sort({victories: -1}).lean()

    for (let i = 0; i < users.length; i++) {
        operations.push({updateOne: {filter: {telegramId: users[i].telegramId}, update: {$set: {ranking: i + 1}}}})
    }

    await User.bulkWrite(operations, {ordered: false})
}

const sendRanking = async (chatId, limit) => {
    // finding and sorting users by victories
    const users = await User.find().sort({victories: -1})
    const result = []

    for (let i = 0; i < users.length && i < limit; i++) {
        result.push(`${users[i].ranking} –º–µ—Å—Ç–æ: ${users[i].name}\n–ü–æ–±–µ–¥: ${users[i].victories}, –ò–≥—Ä: ${users[i].games}`)
    }

    await bot.sendMessage(chatId, result.join('\n\n'))
}

const sendDice = async (telegramId, chatId, options = {}, condition, secondCondition = () => false) => {
    // finding user
    const user = await User.findOne({telegramId})

    if (user.status === false) {
        if (user.coins > 0) {
            // updating user's status
            await User.updateOne({telegramId}, {$set: {status: true}})

            const data = await bot.sendDice(chatId, {
                emoji: options.emoji
            })

            await delay(options.delay)

            if (condition(data.dice.value)) {
                // updating the number of user's victories and coins
                const updatedUser = await User.findOneAndUpdate({telegramId}, {$inc: {victories: 1, coins: options.victoryCoins}}, {new: true})

                await bot.sendMessage(chatId, `–ò–º—è: ${updatedUser.name}; –ë–∞–ª–∞–Ω—Å: ${updatedUser.coins} ${declOfNum(updatedUser.coins, ['–º–æ–Ω–µ—Ç–∞', '–º–æ–Ω–µ—Ç—ã', '–º–æ–Ω–µ—Ç'])} (+${options.victoryCoins})`, options.buttonOptions)
            } else if (secondCondition(data.dice.value)) {
                const updatedUser = await User.findOneAndUpdate({telegramId}, {$inc: {victories: 1, coins: options.partialVictoryCoins}}, {new: true})

                await bot.sendMessage(chatId, `–ò–º—è: ${updatedUser.name}; –ë–∞–ª–∞–Ω—Å: ${updatedUser.coins} ${declOfNum(updatedUser.coins, ['–º–æ–Ω–µ—Ç–∞', '–º–æ–Ω–µ—Ç—ã', '–º–æ–Ω–µ—Ç'])} (+${options.partialVictoryCoins})`, options.buttonOptions)
            } else {
                const updatedUser = await User.findOneAndUpdate({telegramId}, {$inc: {coins: -1}}, {new: true})

                await bot.sendMessage(chatId, `–ò–º—è: ${updatedUser.name}; –ë–∞–ª–∞–Ω—Å: ${updatedUser.coins} ${declOfNum(updatedUser.coins, ['–º–æ–Ω–µ—Ç–∞', '–º–æ–Ω–µ—Ç—ã', '–º–æ–Ω–µ—Ç'])} (-1)`, options.buttonOptions)
            }

            // updating the number of user's games
            await User.updateOne({telegramId}, {$inc: {games: 1}})

            // updating user's status
            await User.updateOne({telegramId}, {$set: {status: false}})
        } else {
            await bot.sendMessage(chatId, `–£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –º–æ–Ω–µ—Ç—ã üòí`)
        }
    }
}

const start = async () => {
    // connecting to db
    try {
        await mongoose.connect(mongoURI)
    } catch (e) {
        console.log(e)
    }

    // setting status to false
    const users = await User.find()

    for (let i = 0; i < users.length; i++) {
        await User.updateOne({telegramId: users[i].telegramId}, {$set: {status: false}})
    }

    // setting bot commands
    await bot.setMyCommands([
        {command: '/start', description: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'},
        {command: '/games', description: '–°–ø–∏—Å–æ–∫ –∏–≥—Ä'},
        {command: '/commands', description: '–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥'},
        {command: '/bonus', description: '–ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å'},
        {command: '/stats', description: '–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'},
        {command: '/ranking', description: '–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤'}
    ])

    // bot on message
    bot.on('message', async (msg) => {
        const telegramId = msg.from.id
        const chatId = msg.chat.id
        const text = msg.text
        const username = msg.from.username
        const firstName = msg.from.first_name
        const lastName = msg.from.last_name
        const name = generateName(username, firstName, lastName)
        const botInfo = await bot.getMe()

        try {
            // inserting user
            await createUser(telegramId, name)

            // finding user
            const user = await User.findOne({telegramId})

            if (text === '/start' || text === `/start@${botInfo.username}`) {
                return bot.sendMessage(chatId, `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name} üëã. –ò–≥—Ä–∞–π –≤ –∏–≥—Ä—ã –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π!\n\n–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –Ω–∞–ø–∏—à–∏ /games\n–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –∫–æ–º–∞–Ω–¥ –Ω–∞–ø–∏—à–∏ /commands`)
            }

            if (text === '/commands' || text === `/commands@${botInfo.username}`) {
                return bot.sendMessage(chatId, '/start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n\n/games - —Å–ø–∏—Å–æ–∫ –∏–≥—Ä\n\n/bonus - –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å\n\n/stats - –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n/ranking - —Ä–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤')
            }

            if (text === '/games' || text === `/games@${botInfo.username}`) {
                return bot.sendMessage(chatId, '–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:', gamesOptions)
            }

            if (text === '/bonus' || text === `/bonus@${botInfo.username}`) {
                return getBonus(telegramId, chatId, {
                    coinsNumber: 6,
                    bonusTime: 6
                })
            }

            if (text === '/ranking' || text === `/ranking@${botInfo.username}`) {
                // updating ranking
                await updateRanking()

                return sendRanking(chatId, 5)
            }

            if (text === '/stats' || text === `/stats@${botInfo.username}`) {
                // updating ranking
                await updateRanking()

                return bot.sendMessage(chatId, `–ò–º—è: ${user.name}\n–ü–æ–±–µ–¥: ${user.victories}\n–ò–≥—Ä: ${user.games}\n–ú–æ–Ω–µ—Ç: ${user.coins}\n–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: ${user.ranking}`)
            }
        } catch (e) {
            console.log(e)
            return bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ :(')
        }
    })

    // bot on callback query
    bot.on('callback_query', async (query) => {
        const chatId = query.message.chat.id
        const telegramId = query.from.id
        const data = query.data
        const username = query.from.username
        const firstName = query.from.first_name
        const lastName = query.from.last_name
        const name = generateName(username, firstName, lastName)

        try {
            // inserting user
            await createUser(telegramId, name)

            if (data === 'slot' || data === 'slotAgain') {
                const winningSlotValues = [64, 1, 22, 43]
                const preWinningSlotValues = [2, 3, 4, 5, 6, 9, 11, 13, 16, 17, 18, 21, 23, 24, 26, 27, 30, 32, 33, 35, 38, 39, 41, 42, 44, 47, 48, 49, 52, 54, 56, 59, 60, 61, 62, 63]

                return sendDice(telegramId, chatId, {
                        emoji: 'üé∞',
                        delay: 2000,
                        victoryCoins: 4,
                        partialVictoryCoins: 1,
                        buttonOptions: slotMachineOptions
                    }, (value) => {
                        return winningSlotValues.includes(value)
                    },
                    (value) => {
                        return preWinningSlotValues.includes(value)
                    })
            }

            if (data === 'basket' || data === 'basketAgain') {
                return sendDice(telegramId, chatId, {
                    emoji: 'üèÄ',
                    delay: 4500,
                    victoryCoins: 2,
                    buttonOptions: basketOptions
                }, (value) => {
                    return value === 4 || value === 5
                })
            }

            if (data === 'bowling' || data === 'bowlingAgain') {
                return sendDice(telegramId, chatId, {
                    emoji: 'üé≥',
                    delay: 4000,
                    victoryCoins: 4,
                    buttonOptions: bowlingOptions
                }, (value) => {
                    return value === 6
                })
            }

            if (data === 'football' || data === 'footballAgain') {
                return sendDice(telegramId, chatId, {
                    emoji: '‚öΩ',
                    delay: 4000,
                    victoryCoins: 2,
                    buttonOptions: footballOptions
                }, (value) => {
                    return value === 4 || value === 5 || value === 3
                })
            }

            if (data === 'darts' || data === 'dartsAgain') {
                return sendDice(telegramId, chatId, {
                    emoji: 'üéØ',
                    delay: 3000,
                    victoryCoins: 4,
                    buttonOptions: dartsOptions
                }, (value) => {
                    return value === 6
                })
            }
        } catch (e) {
            console.log(e)
            return bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ :(')
        }
    })
}

start()